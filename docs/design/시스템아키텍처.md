# COMPASS 시스템 아키텍처

> **문서 버전**: 1.0
> **최종 수정일**: 2026-02-06
> **현재 Phase**: 0-1 (MVP)
> **관련 문서**: [기술스택.md](./기술스택.md), [개발요구사항.md](./개발요구사항.md), [PRD](../prd/PRD-v0.1-detailed.md)

---

## 1. High-Level 시스템 아키텍처

```
+-----------------------------------------------------------+
|                   클라이언트 (Browser)                       |
|         Next.js 15 App Router + React 19                   |
+----------------------------+------------------------------+
                             |
+----------------------------v------------------------------+
|              프레젠테이션 레이어 (Vercel)                     |
|  App Router Pages -- Server Components -- Middleware(RBAC) |
+----------------------------+------------------------------+
                             |
+----------------------------v------------------------------+
|              비즈니스 로직 레이어                              |
|  Server Actions --- Service Layer --- Zod Validation       |
+-------------+-------------+------------------------------+
              |             |
+-------------v---+ +-------v------------------------------+
|  AI 서비스       | |        데이터 레이어 (Supabase)        |
|  레이어          | |  PostgreSQL+RLS -- Auth -- Storage    |
|  Provider       | |                                      |
|  Pattern        | |                                      |
|  (Gemini)       | |                                      |
+-----------------+ +--------------------------------------+
```

### 5개 레이어

| # | 레이어 | 역할 | 기술 |
|---|--------|------|------|
| 1 | 프레젠테이션 | 페이지 렌더링, 라우팅, RBAC 미들웨어 | Next.js 15 App Router |
| 2 | 비즈니스 로직 | Server Actions + Service Layer | Zod 검증 + 서비스 함수 |
| 3 | AI 서비스 | 문제 생성, 채점, OCR | Provider Pattern (Gemini) |
| 4 | 데이터 | DB, 인증, 파일 저장 | Supabase (PostgreSQL + RLS + Auth + Storage) |
| 5 | 횡단 관심사 | 에러 처리, 보안, 환경변수 검증 | 커스텀 에러, Zod env |

---

## 2. 프론트엔드 아키텍처

### 디렉토리 구조

```
src/
├── app/                              # Next.js App Router
│   ├── (auth)/                       # 인증 그룹 (미로그인)
│   │   ├── login/page.tsx
│   │   ├── signup/page.tsx
│   │   └── layout.tsx                # 심플 레이아웃
│   ├── (dashboard)/                  # 대시보드 그룹 (로그인 필수)
│   │   ├── layout.tsx                # 사이드바 + 헤더
│   │   ├── page.tsx                  # 역할별 리다이렉트
│   │   ├── teacher/                  # 교사 전용
│   │   │   ├── questions/            # 문제 관리 (F001,F003,F004)
│   │   │   ├── exams/                # 시험 관리 (F012,F013)
│   │   │   ├── past-exams/           # 기출문제 (F005,F006,F011)
│   │   │   ├── grading/              # 채점 검수 (F016)
│   │   │   └── students/             # 학생 관리
│   │   ├── student/                  # 학생 전용
│   │   │   ├── exams/                # 시험 응시 (F014)
│   │   │   ├── results/              # 성적 조회 (F018)
│   │   │   └── wrong-answers/        # 오답 노트 (F017)
│   │   └── admin/                    # 관리자 전용
│   │       ├── academy/              # 학원 관리 (F008)
│   │       ├── schools/              # 학교 관리 (F007)
│   │       ├── users/                # 사용자 관리 (F009)
│   │       └── standards/            # 성취기준 (F002)
│   ├── api/                          # API Routes (외부 연동 전용)
│   │   ├── ai/callback/route.ts
│   │   ├── webhooks/supabase/route.ts
│   │   └── health/route.ts
│   ├── layout.tsx                    # 루트 레이아웃
│   ├── page.tsx                      # 랜딩 페이지
│   └── not-found.tsx
├── components/
│   ├── ui/                           # shadcn/ui 기본 컴포넌트
│   ├── forms/                        # 폼 컴포넌트 (RHF + Zod)
│   ├── layout/                       # Header, Sidebar, Navigation
│   └── features/                     # 도메인별 컴포넌트
│       ├── questions/
│       ├── exams/
│       ├── grading/
│       └── analytics/
├── lib/
│   ├── supabase/                     # Supabase 클라이언트
│   │   ├── client.ts                 # 브라우저용
│   │   ├── server.ts                 # 서버용
│   │   └── middleware.ts             # 미들웨어용
│   ├── ai/                           # AI 서비스 레이어
│   │   ├── types.ts                  # 인터페이스 정의
│   │   ├── provider.ts              # Factory 함수
│   │   ├── gemini.ts                 # Gemini 구현체
│   │   ├── validation.ts            # 품질 검증
│   │   └── prompts/                  # 프롬프트 템플릿
│   │       ├── question-generation.ts
│   │       ├── grading.ts
│   │       └── ocr-extraction.ts
│   ├── services/                     # 비즈니스 로직
│   │   ├── question.service.ts
│   │   ├── exam.service.ts
│   │   ├── grading.service.ts
│   │   └── analytics.service.ts
│   ├── actions/                      # Server Actions
│   │   ├── auth.actions.ts
│   │   ├── question.actions.ts
│   │   ├── exam.actions.ts
│   │   └── grading.actions.ts
│   ├── validations/                  # Zod 스키마
│   │   ├── auth.schema.ts
│   │   ├── question.schema.ts
│   │   └── exam.schema.ts
│   ├── auth/                         # 인증/인가 헬퍼
│   │   └── permissions.ts
│   ├── errors.ts                     # 커스텀 에러 클래스
│   ├── utils/                        # 범용 유틸리티
│   ├── constants/                    # 상수
│   └── env.ts                        # 환경변수 검증 (Zod)
├── hooks/                            # 커스텀 훅
├── types/                            # TypeScript 타입
│   └── database.types.ts             # Supabase 자동 생성
└── middleware.ts                      # Next.js 미들웨어
```

### 설계 원칙

- **Route Groups**: `(auth)` 미로그인 / `(dashboard)` 로그인 필수 -- URL 영향 없이 레이아웃 분리
- **Server-First**: Server Components 기본, Client Components는 `'use client'` 명시
- **데이터 흐름**: Server Action -> Service Layer -> Supabase Client

### 라우트-기능 매핑

| 라우트 | 기능 ID | 설명 |
|--------|---------|------|
| `/teacher/questions` | F001, F003, F004 | 문제 생성/검수 |
| `/teacher/past-exams` | F005, F006, F011 | 기출문제 관리 |
| `/teacher/exams` | F012, F013 | 시험 생성/PDF |
| `/teacher/grading` | F016 | 채점 검수 |
| `/student/exams` | F014 | 시험 응시/답안 제출 |
| `/student/results` | F018 | 성적 조회 |
| `/student/wrong-answers` | F017 | 오답 노트 |
| `/admin/academy` | F008 | 학원 관리 |
| `/admin/schools` | F007 | 학교 관리 |
| `/admin/users` | F009 | 사용자 관리 |
| `/admin/standards` | F002 | 성취기준 관리 |
| `/login`, `/signup` | F010 | 인증 |
| 대시보드 | F018, F019 | 역할별 대시보드/리포트 |

---

## 3. 백엔드 아키텍처

### 데이터 흐름 패턴

```
Client Component -> Server Action (Zod 검증 + 인증 확인)
  -> Service Layer (비즈니스 로직)
    -> Supabase Client (DB + Storage, RLS 자동 적용)
    -> AI Provider (문제 생성/채점)
  -> 결과 반환 (revalidatePath)
```

### Server Action 패턴

```typescript
// lib/actions/utils.ts -- 공통 Server Action 래퍼
type ActionResult<T> =
  | { success: true; data: T }
  | { success: false; error: string; code?: string }

export function createAction<TInput, TOutput>(
  schema: ZodSchema<TInput>,
  handler: (input: TInput, user: User) => Promise<TOutput>
): (formData: FormData) => Promise<ActionResult<TOutput>>
```

### 역할 분리

| 레이어 | 역할 | 예시 |
|--------|------|------|
| Server Actions | 폼 제출, CRUD 등 사용자 상호작용 | `question.actions.ts` |
| API Routes | 외부 연동(웹훅, AI 콜백, 헬스체크) | `api/webhooks/supabase/route.ts` |
| Service Layer | 비즈니스 로직 집중 | `question.service.ts` |

> **Phase 2+ 전환**: Service Layer는 NestJS 전환 시 그대로 재사용

---

## 4. 데이터베이스 스키마 (15 테이블)

### 테이블 목록

| 구분 | 테이블 | 설명 |
|------|--------|------|
| 인프라 | `academies` | 학원 (테넌트) |
| 인프라 | `profiles` | 사용자 프로필 (auth.users 연동) |
| 인프라 | `schools` | 학교 정보 |
| 확장 | `students` | 학생 확장 정보 |
| 확장 | `teachers` | 교사 확장 정보 |
| 교육과정 | `achievement_standards` | 성취기준 (교육부 학습목표) |
| 문제 | `questions` | 문제 (AI 생성 + 수동) |
| 문제 | `past_exam_questions` | 기출문제 (학교별) |
| 시험 | `exams` | 시험 |
| 시험 | `exam_questions` | 시험-문제 연결 (M:N) |
| 채점 | `exam_submissions` | 시험 제출 |
| 채점 | `answers` | 답안 (AI 채점 + 교사 검수) |
| 분석 | `wrong_answer_notes` | 오답 노트 |
| 분석 | `grade_appeals` | 이의제기 |
| 모니터링 | `ai_generation_logs` | AI 생성 로그 |

### ER 다이어그램

```
academies (1) -------- (*) profiles
profiles (1) --------- (0..1) students
profiles (1) --------- (0..1) teachers
students (*) --------- (1) schools
schools (1) ---------- (*) past_exam_questions
achievement_standards (1) -- (*) questions
questions (*) -------- (*) exams (via exam_questions)
exams (1) ------------ (*) exam_submissions
exam_submissions (1) - (*) answers
answers (*) ---------- (1) questions
students (1) --------- (*) wrong_answer_notes
students (1) --------- (*) exam_submissions
```

### 핵심 테이블 상세

상세 SQL은 `supabase/migrations/00001_initial_schema.sql` 참조.

#### questions (핵심 테이블)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID PK | 기본키 |
| academy_id | UUID FK | 학원 (테넌트 격리) |
| created_by | UUID FK | 생성자 |
| content | TEXT | 문제 내용 |
| type | TEXT | multiple_choice / short_answer / descriptive |
| options | JSONB | 객관식 보기 |
| answer | TEXT | 정답 |
| explanation | TEXT | 해설 |
| difficulty | INTEGER(1-5) | 난이도 |
| points | INTEGER | 배점 |
| achievement_standard_id | UUID FK | 성취기준 연결 |
| subject | TEXT | 과목 |
| grade | INTEGER | 학년 |
| unit | TEXT | 단원 |
| is_ai_generated | BOOLEAN | AI 생성 여부 |
| ai_review_status | TEXT | none/pending/approved/rejected |
| ai_model | TEXT | 사용된 AI 모델 |
| ai_generation | INTEGER | 모델 붕괴 방지용 세대 추적 |
| source_type | TEXT | past_exam/textbook/self_made/ai_generated |

#### answers (AI 채점 + 교사 검수)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID PK | 기본키 |
| submission_id | UUID FK | 시험 제출 |
| question_id | UUID FK | 문제 |
| student_answer | TEXT | 학생 답안 |
| is_correct | BOOLEAN | 정답 여부 |
| ai_score | NUMERIC | AI 채점 점수 |
| ai_confidence | NUMERIC(0-1) | AI 신뢰도 |
| ai_feedback | TEXT | AI 피드백 |
| needs_review | BOOLEAN | 교사 검수 필요 (confidence < 0.8) |
| teacher_score | NUMERIC | 교사 최종 점수 |
| teacher_feedback | TEXT | 교사 피드백 |

### 멀티테넌시 (RLS)

모든 비즈니스 테이블에 `academy_id` 포함. RLS 정책으로 데이터 격리:

```sql
-- 예: questions 테이블
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "questions_academy_isolation" ON questions
  FOR ALL USING (
    academy_id = (SELECT academy_id FROM profiles WHERE id = auth.uid())
  );
```

상세 정책은 `supabase/migrations/00002_rls_policies.sql` 참조.

---

## 5. AI 서비스 레이어

### Provider Pattern (Strategy + Factory)

```typescript
// lib/ai/types.ts -- 인터페이스 정의
interface AIProvider {
  generateQuestions(params: GenerateQuestionParams): Promise<GeneratedQuestion[]>
  gradeAnswer(params: GradeAnswerParams): Promise<GradingResult>
  extractFromImage(params: OCRParams): Promise<OCRResult>
  analyzePastExamTrends(questions: GeneratedQuestion[]): Promise<ExamTrendAnalysis>
}

// lib/ai/provider.ts -- Factory
export function createAIProvider(type?: ProviderType): AIProvider {
  switch (type || process.env.AI_PROVIDER || 'gemini') {
    case 'gemini': return new GeminiProvider({ ... })
    // Phase 2+: case 'openai': return new OpenAIProvider({ ... })
    default: throw new Error('지원하지 않는 AI Provider')
  }
}

// lib/ai/gemini.ts -- Gemini 구현체
export class GeminiProvider implements AIProvider { ... }
```

### 프롬프트 템플릿

| 파일 | 용도 |
|------|------|
| `question-generation.ts` | 문제 생성 (학년/단원/난이도/기출참고) |
| `grading.ts` | 채점 (객관식 자동 + 서술형 AI) |
| `ocr-extraction.ts` | OCR 추출 (기출 이미지 -> 구조화) |
| `trend-analysis.ts` | 출제 경향 분석 |

### 품질 검증 레이어 (`lib/ai/validation.ts`)

- 필수 필드 확인 (content, answer)
- 객관식 보기 5개 확인
- 난이도 범위 검증 (1-5)
- JSON 파싱 오류 처리
- 중복 문제 감지

### HITL (Human-in-the-Loop) 정책

| 대상 | 정책 | 조건 |
|------|------|------|
| AI 생성 문제 | 교사 검수 필수 | `ai_review_status: 'pending'` |
| AI 채점 | 교사 검수 필수 | `confidence < 0.8` -> `needs_review: true` |
| 모델 붕괴 방지 | 세대 추적 | `ai_generation` 필드, 원본 데이터 70% 유지 |

---

## 6. 인증/인가 시스템

### 보안 3중 레이어

```
Layer 1: Middleware (라우트 가드)
├── 인증 확인 (Supabase Auth getUser())
├── RBAC 라우트 접근 제어 (역할별 경로 매핑)
└── 미인증/권한 없음 -> 리다이렉트

Layer 2: Server Actions (비즈니스 규칙)
├── Zod 입력 검증
├── hasPermission() 권한 확인
└── 에러 처리 (민감 정보 미노출)

Layer 3: Database RLS (데이터 격리)
├── academy_id 기반 테넌트 격리
└── 최후의 방어선
```

### RBAC 라우트 매핑

```typescript
const ROLE_ROUTES: Record<string, string[]> = {
  student: ['/student'],
  teacher: ['/teacher'],
  admin: ['/admin'],
  system_admin: ['/admin', '/teacher', '/student', '/system'],
}
```

### 권한 매트릭스

| 기능 | student | teacher | admin | system_admin |
|------|---------|---------|-------|--------------|
| 문제 생성 | - | O | - | O |
| 문제 검수 | - | O | - | O |
| 시험 생성 | - | O | - | O |
| 답안 제출 | O | - | - | O |
| 채점 검수 | - | O | - | O |
| 사용자 관리 | - | - | O | O |
| 학원 설정 | - | - | O | O |

### 인증 방식 (Phase 0-1)

- 이메일/비밀번호 (기본)
- 카카오 소셜 로그인
- 네이버 소셜 로그인
- Google 소셜 로그인

---

## 7. 파일 스토리지 (Supabase Storage)

```
Buckets:
├── past-exams/          # 기출문제 이미지 (교사 업로드)
│   └── {academy_id}/{school_id}/{year}/{filename}
├── answer-sheets/       # 답안지 이미지 (학생 업로드)
│   └── {academy_id}/{student_id}/{exam_id}/{filename}
├── reports/             # PDF 리포트 (시스템 생성)
│   └── {academy_id}/{type}/{filename}
└── avatars/             # 프로필 이미지
    └── {user_id}/{filename}
```

---

## 8. 에러 처리 전략

### 커스텀 에러 클래스 (`lib/errors.ts`)

```
AppError (base)
├── AuthError (401)
├── ForbiddenError (403)
├── ValidationError (400)
├── NotFoundError (404)
└── AIServiceError (502)
```

### Server Action 통일 응답 패턴

```typescript
type ActionResult<T> =
  | { success: true; data: T }
  | { success: false; error: string; code?: string }
```

---

## 9. 환경변수

```bash
# .env.local
# Public (클라이언트 노출 안전)
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Private (서버 전용)
SUPABASE_SERVICE_ROLE_KEY=eyJ...
GEMINI_API_KEY=AIza...
GEMINI_MODEL=gemini-2.0-flash
AI_PROVIDER=gemini
```

`lib/env.ts`에서 Zod로 런타임 검증.

---

## 10. 핵심 유스케이스 데이터 흐름

### UC1: AI 문제 생성 (교사)

```
폼 입력 -> Server Action(Zod 검증 + 인증)
-> QuestionService.generateWithAI()
-> AI Provider(Gemini) -> 프롬프트 템플릿 + 파라미터
-> 응답 파싱 + 품질 검증
-> DB 저장 (ai_review_status: 'pending')
-> AI 로그 기록
-> UI 갱신
```

### UC2: 시험 생성 -> PDF 출력 (교사)

```
시험 폼 -> ExamService.create() -> exams + exam_questions DB 저장
-> PDF 요청 -> @react-pdf/renderer
-> 다운로드/인쇄
```

### UC3: 답안 제출 -> AI 채점 -> 교사 검수

```
학생: 답안 업로드 -> Storage(answer-sheets/)
-> GradingService.grade()
-> AI Provider(채점) -> confidence 기반 분류
-> answers 저장 (confidence < 0.8 -> needs_review: true)
-> 오답 자동 생성 (wrong_answer_notes)

교사: needs_review 목록 확인 -> 검수(승인/수정) -> 최종 확정
```

---

## 11. Phase 2+ 전환 전략

| Phase 0-1 | Phase 2+ | 전환 비용 |
|-----------|----------|----------|
| Server Actions | NestJS Controllers | Service Layer 재사용 |
| Supabase Client | TypeORM + RDS | 데이터 접근만 교체 |
| Supabase Auth | Passport + JWT | 인증 레이어만 교체 |
| Supabase Storage | AWS S3 SDK | S3 호환으로 최소 수정 |
| AI Provider (Gemini) | + OpenAI/Claude 추가 | Factory에 case 추가 |
| Zod Schemas | 공유 패키지로 이동 | 그대로 재사용 |

**핵심**: Service Layer를 분리하되 과도한 추상화(Repository Pattern 등)는 MVP에서 도입하지 않음. Phase 2 전환 시 데이터 접근 부분만 교체.

---

## 12. 검증 방법

1. **문서 정합성**: 기존 가이드 문서(project-structure.md, component-patterns.md)와 디렉토리 구조 일치 확인
2. **PRD 커버리지**: 19개 기능(F001-F019) 모두 라우트/서비스에 매핑되었는지 확인
3. **스키마 검증**: `supabase/migrations/` SQL을 Supabase 대시보드에서 실행 후 테이블 관계 검증
4. **AI 통합 테스트**: Gemini API 키 설정 후 문제 생성 1건 E2E 테스트
5. **RLS 테스트**: 다른 학원 데이터 접근 불가 확인
6. **RBAC 테스트**: 역할별 라우트 접근 제어 확인

---

## 문서 이력

| 버전 | 일자 | 변경 내용 |
|------|------|----------|
| 1.0 | 2026-02-06 | 초안 작성 |
